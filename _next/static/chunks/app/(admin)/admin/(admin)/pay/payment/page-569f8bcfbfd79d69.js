(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1998],{2129:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>_});var r=i(95155),n=i(12115),a=i(20063),s=i(19279),l=i(89543),o=i(36060),d=i(91442),c=i(785),p=i(15856),x=i(43561),g=i(49073),u=i(32587),y=i(81184),h=i(65982),f=i(63646),b=i(2995),j=i(8805),m=i(44074),v=i(55248),w=i(21282),S=i(44241),A=i(37783);let k="https://cap.rustplus.cn/336bfb3b1a/",{Title:C,Text:T}=s.A;function z(e){var t;let{product:i,showWechatPay:a,showAlipay:s}=e,[o,z]=(0,n.useState)("alipay"),[E,P]=(0,n.useState)(!1),[_,B]=(0,n.useState)(""),[I,W]=(0,n.useState)(!1),[R,D]=(0,n.useState)(null),{modal:O,message:F}=l.A.useApp(),[M,q]=(0,n.useState)(!1),N=(0,n.useRef)(null);(0,n.useEffect)(()=>{if(window.Cap){N.current=new window.Cap({apiEndpoint:k}),q(!0);return}let e=document.createElement("script");e.src="/cap-widget.js",e.async=!0,e.onload=()=>{window.Cap&&(N.current=new window.Cap({apiEndpoint:k}),q(!0))},document.head.appendChild(e)},[]);let U=(0,n.useCallback)(async()=>{if(!M||!N.current)return F.error("人机验证组件未加载完成，请稍后重试"),null;try{return(await N.current.solve()).token}catch(e){return F.error("人机验证失败，请重试"),null}},[M,F]),G=async()=>{P(!0);try{let e=await U();if(!e)return void P(!1);let t="wxpay"===o?"/api/pay/a/querywxpayorderissuccess":"/api/pay/a/queryalipayorderissuccess",r=await A.Aq.backendFetch("wxpay"===o?"/api/pay/wxpay/native":"/api/pay/alipay/native",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:_||"",goods_id:i.goods_id,capToken:e})}),n=await r.json();if(200!==n.status){F.error(n.errmessage||"下单失败"),P(!1);return}D(n.data),W(!0),P(!1),"alipay"===o&&window.open(n.data.code_url,"_blank");let a=n.data.out_trade_no;for(let e=0;e<120;e++){let e=await A.Aq.backendFetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({out_trade_no:a})}),i=await e.json();if(200===i.status)return void H();await new Promise(e=>setTimeout(e,1e3))}}finally{P(!1)}},H=()=>{O.success({icon:null,content:(0,r.jsxs)("div",{style:{textAlign:"center",padding:"20px 0"},children:[(0,r.jsx)(m.A,{style:{color:"#10b981",fontSize:"64px",marginBottom:"16px"}}),(0,r.jsx)(C,{level:4,style:{color:"#fff",margin:"0 0 8px 0"},children:"支付成功"}),(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.6)"},children:"感谢您的兑换，商品已到账"}),(0,r.jsx)(c.Ay,{type:"primary",style:{marginTop:"24px",width:"100%"},onClick:()=>{p.A.destroyAll(),window.location.href="/admin"},children:"返回控制台"})]}),footer:null,closable:!0,width:360,centered:!0})};return(0,r.jsx)("div",{style:{position:"relative"},children:(0,r.jsx)("div",{style:{position:"relative",zIndex:1,maxWidth:"720px",margin:"0 auto"},children:(0,r.jsxs)("div",{style:{background:"linear-gradient(145deg, #27272c 0%, #1b1b1f 100%)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:"20px",overflow:"hidden"},children:[(0,r.jsx)("div",{style:{height:"3px",background:"linear-gradient(90deg, #6366f1, #8b5cf6, #6366f1)"}}),(0,r.jsxs)("div",{style:{padding:"28px"},children:[(0,r.jsx)("div",{style:{textAlign:"center",marginBottom:"24px"},children:(0,r.jsx)(C,{level:4,style:{margin:0,color:"#fff"},children:"确认订单"})}),(0,r.jsxs)("div",{style:{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:"14px",padding:"20px",marginBottom:"24px"},children:[(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"16px"},children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.5)",fontSize:"13px"},children:"商品名称"}),(0,r.jsx)("div",{style:{color:"#fff",fontWeight:600,fontSize:"16px",marginTop:"4px"},children:i.name})]}),(0,r.jsxs)("div",{style:{textAlign:"right"},children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.5)",fontSize:"13px"},children:"支付金额"}),(0,r.jsxs)("div",{style:{marginTop:"4px"},children:[i.originalPrice&&i.originalPrice!==i.price&&(0,r.jsxs)(T,{delete:!0,style:{color:"rgba(255,255,255,0.35)",marginRight:"8px"},children:["\xa5",i.originalPrice.toFixed(2)]}),(0,r.jsxs)("span",{style:{color:"#f87171",fontWeight:700,fontSize:"24px"},children:["\xa5",i.price.toFixed(2)]})]})]})]}),(i.currentExpiry||i.daysToAdd)&&(0,r.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px",padding:"12px 0",borderTop:"1px solid rgba(255,255,255,0.06)"},children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.4)",fontSize:"12px"},children:"当前到期"}),(0,r.jsx)("div",{style:{color:"rgba(255,255,255,0.8)",fontSize:"14px",marginTop:"2px"},children:i.currentExpiry?A.Aq.formatDateTime(i.currentExpiry):"--"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.4)",fontSize:"12px"},children:"兑换后到期"}),(0,r.jsx)("div",{style:{color:"#10b981",fontSize:"14px",marginTop:"2px"},children:(()=>{if(!i.daysToAdd)return"--";let e=new Date,t=i.currentExpiry?new Date(i.currentExpiry):e;t<e&&(t=e);let r=new Date(t);return r.setDate(t.getDate()+i.daysToAdd),r.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(/\//g,"-")})()})]})]}),(null==(t=i.features)?void 0:t.length)>0&&(0,r.jsxs)("div",{style:{paddingTop:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.4)",fontSize:"12px",display:"block",marginBottom:"10px"},children:"包含功能"}),(0,r.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:i.features.map((e,t)=>(0,r.jsxs)(x.A,{style:{background:"rgba(16, 185, 129, 0.1)",border:"1px solid rgba(16, 185, 129, 0.2)",color:"#6ee7b7",borderRadius:"6px"},children:[(0,r.jsx)(b.A,{style:{marginRight:"4px"}}),e]},t))})]})]}),I?(0,r.jsx)(()=>{if(!R)return null;let[e,t]=(0,n.useState)(R.time_expire+R.advance_seconds);return(0,n.useEffect)(()=>{let e=setInterval(()=>{t(e=>e<=1?0:e-1)},1e3);return()=>clearInterval(e)},[]),(0,r.jsxs)("div",{style:{textAlign:"center",padding:"20px 0"},children:[(0,r.jsx)("div",{style:{display:"inline-block",padding:"20px",background:"#fff",borderRadius:"16px",boxShadow:"0 4px 24px rgba(0,0,0,0.2)"},children:"wxpay"===o?(0,r.jsx)(d.A,{value:R.code_url,size:200,color:"#000",bgColor:"#fff"}):(0,r.jsxs)("div",{style:{padding:"20px",textAlign:"center"},children:[(0,r.jsx)(b.A,{style:{fontSize:"48px",color:"#1677ff",marginBottom:"16px"}}),(0,r.jsx)("div",{style:{color:"#333",fontSize:"16px",marginBottom:"8px"},children:"订单已创建"}),(0,r.jsx)("div",{style:{color:"#666",fontSize:"14px"},children:"已跳转至支付宝付款页面"})]})}),(0,r.jsxs)("div",{style:{marginTop:"20px"},children:[(0,r.jsxs)("div",{style:{display:"inline-flex",alignItems:"center",gap:"8px",padding:"8px 16px",background:"rgba(99, 102, 241, 0.1)",borderRadius:"20px",marginBottom:"12px"},children:[(0,r.jsx)(j.A,{style:{color:"#818cf8"}}),(0,r.jsxs)(T,{style:{color:"#818cf8"},children:["有效期: ",(e=>{let t=Math.floor(e/60);return"".concat(t.toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0"))})(e)]})]}),(0,r.jsxs)(T,{style:{color:"rgba(255,255,255,0.4)",fontSize:"13px",display:"block"},children:["wxpay"===o?"请使用微信扫码支付":"请在新窗口完成支付"," \xb7 支付后自动到账"]})]})]})},{}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.5)",fontSize:"13px",display:"block",marginBottom:"8px"},children:"充值账号"}),(0,r.jsx)(g.A,{disabled:!0,value:i.useremail,style:{background:"rgba(255,255,255,0.03)",height:"44px"}})]}),(0,r.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.5)",fontSize:"13px",display:"block",marginBottom:"12px"},children:"支付方式"}),(0,r.jsx)(u.Ay.Group,{onChange:e=>z(e.target.value),value:o,style:{width:"100%"},children:(0,r.jsxs)(y.A,{gutter:12,children:[s&&(0,r.jsx)(h.A,{span:12,children:(0,r.jsx)("div",{onClick:()=>z("alipay"),style:{padding:"16px",background:"alipay"===o?"rgba(22, 119, 255, 0.1)":"rgba(255,255,255,0.03)",border:"alipay"===o?"1px solid rgba(22, 119, 255, 0.4)":"1px solid rgba(255,255,255,0.08)",borderRadius:"12px",cursor:"pointer",transition:"all 0.2s"},children:(0,r.jsxs)(f.A,{children:[(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"10px",background:"#1677ff",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,r.jsx)(v.A,{style:{color:"#fff",fontSize:"22px"}})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{style:{color:"#fff",fontWeight:500},children:"支付宝"}),(0,r.jsx)(x.A,{color:"#ff6010",style:{fontSize:"10px",marginTop:"2px"},children:"推荐"})]})]})})}),a&&(0,r.jsx)(h.A,{span:12,children:(0,r.jsx)("div",{onClick:()=>z("wxpay"),style:{padding:"16px",background:"wxpay"===o?"rgba(82, 196, 26, 0.1)":"rgba(255,255,255,0.03)",border:"wxpay"===o?"1px solid rgba(82, 196, 26, 0.4)":"1px solid rgba(255,255,255,0.08)",borderRadius:"12px",cursor:"pointer",transition:"all 0.2s"},children:(0,r.jsxs)(f.A,{children:[(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"10px",background:"#52c41a",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,r.jsx)(w.A,{style:{color:"#fff",fontSize:"22px"}})}),(0,r.jsx)("div",{style:{color:"#fff",fontWeight:500},children:"微信支付"})]})})})]})})]}),(0,r.jsxs)("div",{style:{marginBottom:"24px"},children:[(0,r.jsx)(T,{style:{color:"rgba(255,255,255,0.5)",fontSize:"13px",display:"block",marginBottom:"8px"},children:"邀请码（可选）"}),(0,r.jsx)(g.A,{value:_,onChange:e=>B(e.target.value),placeholder:"输入邀请码可享优惠",style:{height:"44px"}})]}),(0,r.jsx)(c.Ay,{type:"primary",size:"large",block:!0,onClick:G,loading:E,icon:"alipay"===o?(0,r.jsx)(v.A,{}):(0,r.jsx)(w.A,{}),style:{height:"52px",fontSize:"16px",fontWeight:600,borderRadius:"14px",background:"alipay"===o?"linear-gradient(135deg, #1677ff 0%, #0958d9 100%)":"linear-gradient(135deg, #52c41a 0%, #389e0d 100%)",boxShadow:"alipay"===o?"0 4px 16px rgba(22, 119, 255, 0.3)":"0 4px 16px rgba(82, 196, 26, 0.3)"},children:E?"处理中...":"立即支付 \xa5".concat(i.price.toFixed(2))}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",marginTop:"20px",color:"rgba(255,255,255,0.35)",fontSize:"12px"},children:[(0,r.jsx)(S.A,{}),(0,r.jsx)("span",{children:"安全支付 \xb7 即时到账 \xb7 如有问题请联系客服"})]})]})]})]})})})}let{Text:E}=s.A;function P(){let e=(0,a.useSearchParams)().get("goods_id"),{message:t}=l.A.useApp(),[i,s]=(0,n.useState)(null),[d,c]=(0,n.useState)(!0),[p,x]=(0,n.useState)(null);return((0,n.useEffect)(()=>{(async()=>{if(!e){x("未指定商品ID"),c(!1);return}try{c(!0);let t=await A.Aq.backendFetch("/api/pay/getuserinfo",{method:"POST"});if(!t.ok){x("无法获取用户信息，您可能未登录"),c(!1);return}let i=await t.json();if(200!==i.status){x(i.errmessage||"无法获取用户信息，您可能未登录"),c(!1);return}let r=await A.Aq.backendFetch("/api/pay/getgoodsbyid",{method:"POST",body:JSON.stringify({id:e}),headers:{"Content-Type":"application/json"}});if(!r.ok){x("请求失败,请检查网络"),c(!1);return}let n=await r.json();if(200!==n.status){x(n.errmessage||"商品不存在"),c(!1);return}let a=i.data,l=n.data,o={goods_id:l.goods_id,name:l.name,price:l.price/100,originalPrice:l.originalPrice/100,features:l.features||[],discount:l.discount,useremail:a.email};l.isMain&&(o.currentExpiry=a.activationEndAt,o.daysToAdd=a.daysToAdd),s(o),x(null)}catch(e){console.error("加载数据失败:",e),x("加载失败，请稍后重试"),t.error("加载失败，请稍后重试")}finally{c(!1)}})()},[e,t]),d)?(0,r.jsxs)("div",{style:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:"60vh",gap:"16px"},children:[(0,r.jsx)(o.A,{size:"large"}),(0,r.jsx)(E,{style:{color:"rgba(255,255,255,0.5)"},children:"加载中..."})]}):p||!i?(0,r.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh",color:"rgba(255, 255, 255, 0.85)"},children:(0,r.jsxs)("div",{style:{textAlign:"center"},children:[(0,r.jsx)("h2",{children:p||"商品不存在"}),(0,r.jsx)("a",{href:"/admin/pay/products",style:{color:"#818cf8"},children:"返回商品列表"})]})}):(0,r.jsx)(z,{product:i,showWechatPay:!0,showAlipay:!0})}function _(){return(0,r.jsx)(n.Suspense,{fallback:(0,r.jsxs)("div",{style:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:"60vh",gap:"16px"},children:[(0,r.jsx)(o.A,{size:"large"}),(0,r.jsx)(E,{style:{color:"rgba(255,255,255,0.5)"},children:"加载中..."})]}),children:(0,r.jsx)(P,{})})}},17715:(e,t,i)=>{Promise.resolve().then(i.bind(i,2129))},37783:(e,t,i)=>{"use strict";i.d(t,{Aq:()=>n,Ay:()=>a});let r=i(70636).env.NEXT_PUBLIC_GATEWAY_URL||"https://gateway.rustplus.cn";class n{static formatDateTime(e){let t=new Date(e),i=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return"".concat(i,"-").concat(r,"-").concat(n," ").concat(a,":").concat(s)}static async copyToClipboard(e,t){let{onSuccess:i,onError:r}=t||{};try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(e),null==i||i(),!0;let t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{let e=document.execCommand("copy");if(document.body.removeChild(t),e)return null==i||i(),!0}catch(e){throw document.body.removeChild(t),e}return window.prompt("复制失败，请手动复制以下文本:",e),null==i||i(),!0}catch(e){return null==r||r(e instanceof Error?e:Error(String(e))),!1}}static toBoolean(e){return"string"==typeof e?"true"===(e=e.toLowerCase().trim())||"1"===e:!!e}static getGatewayUrl(e){return e.startsWith("/api/pay/")?"".concat(r).concat(e):e.startsWith("/api/")?"".concat(r,"/api/backend").concat(e.slice(4)):"".concat(r).concat(e)}static async backendFetch(e,t){return fetch(n.getGatewayUrl(e),{credentials:"include",...t}).then(e=>403===e.status?(window.location.pathname.startsWith("/login")||(window.location.href="/login"),Promise.reject(Error("Unauthorized"))):e).catch(e=>{throw e})}static getCookie(e){var t,i;let r="; ".concat(document.cookie).split("; ".concat(e,"="));if(2===r.length)return null!=(i=null==(t=r.pop())?void 0:t.split(";").shift())?i:""}static detectDevice(){if("undefined"==typeof navigator)return{isMobile:!1,isWechat:!1,isIOS:!1,isAndroid:!1};let e=navigator.userAgent;return{isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),isWechat:/MicroMessenger/i.test(e),isIOS:/iPhone|iPad|iPod/i.test(e),isAndroid:/Android/i.test(e)}}}let a={domain:"rustplus.cn",payWebUrl:"https://pay.rustplus.cn"}}},e=>{e.O(0,[4041,6083,785,6240,9279,2245,9543,9073,6060,2587,6980,4818,8441,1255,7358],()=>e(e.s=17715)),_N_E=e.O()}]);